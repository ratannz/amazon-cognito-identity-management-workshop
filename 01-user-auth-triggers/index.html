



<!doctype html>
<html lang="en" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      <meta http-equiv="x-ua-compatible" content="ie=edge">
      
        <meta name="description" content="In this workshop, you learn how to build a serverless customer-facing microservices application demonstrating end-to-end authentication and authorization using Amazon Cognito, Amazon API Gateway, AWS Lambda, and all things AWS Identity and Access Management (IAM). You have the opportunity to build an end-to-end functional app with a secure identity provider showcasing user authentication patterns.">
      
      
        <link rel="canonical" href="https://serverless-idm.awssecworkshops.com/01-user-auth-triggers/">
      
      
        <meta name="author" content="aws-security-workshops@amazon.com">
      
      
        <meta name="lang:clipboard.copy" content="Copy to clipboard">
      
        <meta name="lang:clipboard.copied" content="Copied to clipboard">
      
        <meta name="lang:search.language" content="en">
      
        <meta name="lang:search.pipeline.stopwords" content="True">
      
        <meta name="lang:search.pipeline.trimmer" content="True">
      
        <meta name="lang:search.result.none" content="No matching documents">
      
        <meta name="lang:search.result.one" content="1 matching document">
      
        <meta name="lang:search.result.other" content="# matching documents">
      
        <meta name="lang:search.tokenizer" content="[\s\-]+">
      
      <link rel="shortcut icon" href="../assets/images/aws-favicon.ico">
      <meta name="generator" content="mkdocs-1.0.4, mkdocs-material-4.0.2">
    
    
      
        <title>Module 1 <small> EXT 1 - Lambda Triggers</small> - AWS Identity: Using Amazon Cognito for serverless consumer apps</title>
      
    
    
      <link rel="stylesheet" href="../assets/stylesheets/application.982221ab.css">
      
      
    
    
      <script src="../assets/javascripts/modernizr.1f0bcf2b.js"></script>
    
    
      
        <link href="https://fonts.gstatic.com" rel="preconnect" crossorigin>
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,400,400i,700|Roboto+Mono">
        <style>body,input{font-family:"Roboto","Helvetica Neue",Helvetica,Arial,sans-serif}code,kbd,pre{font-family:"Roboto Mono","Courier New",Courier,monospace}</style>
      
    
    <link rel="stylesheet" href="../assets/fonts/material-icons.css">
    
    
      <link rel="stylesheet" href="../stylesheets/custom.css">
    
    
      
    
    
  </head>
  
    <body dir="ltr">
  
    <svg class="md-svg">
      <defs>
        
        
          <svg xmlns="http://www.w3.org/2000/svg" width="416" height="448"
    viewBox="0 0 416 448" id="__github">
  <path fill="currentColor" d="M160 304q0 10-3.125 20.5t-10.75 19-18.125
        8.5-18.125-8.5-10.75-19-3.125-20.5 3.125-20.5 10.75-19 18.125-8.5
        18.125 8.5 10.75 19 3.125 20.5zM320 304q0 10-3.125 20.5t-10.75
        19-18.125 8.5-18.125-8.5-10.75-19-3.125-20.5 3.125-20.5 10.75-19
        18.125-8.5 18.125 8.5 10.75 19 3.125 20.5zM360
        304q0-30-17.25-51t-46.75-21q-10.25 0-48.75 5.25-17.75 2.75-39.25
        2.75t-39.25-2.75q-38-5.25-48.75-5.25-29.5 0-46.75 21t-17.25 51q0 22 8
        38.375t20.25 25.75 30.5 15 35 7.375 37.25 1.75h42q20.5 0
        37.25-1.75t35-7.375 30.5-15 20.25-25.75 8-38.375zM416 260q0 51.75-15.25
        82.75-9.5 19.25-26.375 33.25t-35.25 21.5-42.5 11.875-42.875 5.5-41.75
        1.125q-19.5 0-35.5-0.75t-36.875-3.125-38.125-7.5-34.25-12.875-30.25-20.25-21.5-28.75q-15.5-30.75-15.5-82.75
        0-59.25 34-99-6.75-20.5-6.75-42.5 0-29 12.75-54.5 27 0 47.5 9.875t47.25
        30.875q36.75-8.75 77.25-8.75 37 0 70 8 26.25-20.5
        46.75-30.25t47.25-9.75q12.75 25.5 12.75 54.5 0 21.75-6.75 42 34 40 34
        99.5z" />
</svg>
        
      </defs>
    </svg>
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
    <label class="md-overlay" data-md-component="overlay" for="__drawer"></label>
    
      <a href="#module-1-ext-1-lambda-triggers" tabindex="1" class="md-skip">
        Skip to content
      </a>
    
    
      <!--
  Copyright (c) 2016-2018 Martin Donath <martin.donath@squidfunk.com>
  Permission is hereby granted, free of charge, to any person obtaining a copy
  of this software and associated documentation files (the "Software"), to
  deal in the Software without restriction, including without limitation the
  rights to use, copy, modify, merge, publish, distribute, sublicense, and/or
  sell copies of the Software, and to permit persons to whom the Software is
  furnished to do so, subject to the following conditions:
  The above copyright notice and this permission notice shall be included in
  all copies or substantial portions of the Software.
  THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR
  IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,
  FITNESS FOR A PARTICULAR PURPOSE AND NON-INFRINGEMENT. IN NO EVENT SHALL THE
  AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER
  LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING
  FROM, OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS
  IN THE SOFTWARE.
-->

<!-- Application header -->
<header class="md-header" data-md-component="header">

    <!-- Top-level navigation -->
    <nav class="md-header-nav md-grid">
      <div class="md-flex">
  
        <!-- Link to home -->
        <div class="md-flex__cell md-flex__cell--shrink">
          <a href="https://aws.amazon.com/"
              title="Amazon Web Services"
              class="md-header-nav__button md-logo">
            
              <img src="../assets/images/aws_smile_logo.png" width="40" height="24" />
            
          </a>
        </div>
  
        <!-- Button to toggle drawer -->
        <div class="md-flex__cell md-flex__cell--shrink">
          <label class="md-icon md-icon--menu md-header-nav__button"
              for="__drawer"></label>
        </div>
  
        <!-- Header title -->
        <div class="md-flex__cell md-flex__cell--stretch">
          <div class="md-flex__ellipsis md-header-nav__title"
              data-md-component="title">
            
              
                <span class="md-header-nav__topic">
                  AWS Identity: Using Amazon Cognito for serverless consumer apps
                </span>
                <span class="md-header-nav__topic">
                  Module 1 <small> EXT 1 - Lambda Triggers</small>
                </span>
              
            
          </div>
        </div>
        
        
        <!-- Button to open search dialogue -->
        <!--
        <div class="md-flex__cell md-flex__cell--shrink">
          
            
              <label class="md-icon md-icon--search md-header-nav__button"
                  for="__search"></label>
  
              
<div class="md-search" data-md-component="search" role="dialog">
  <label class="md-search__overlay" for="__search"></label>
  <div class="md-search__inner" role="search">
    <form class="md-search__form" name="search">
      <input type="text" class="md-search__input" name="query" placeholder="Search" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck="false" data-md-component="query" data-md-state="active">
      <label class="md-icon md-search__icon" for="__search"></label>
      <button type="reset" class="md-icon md-search__icon" data-md-component="reset" tabindex="-1">
        &#xE5CD;
      </button>
    </form>
    <div class="md-search__output">
      <div class="md-search__scrollwrap" data-md-scrollfix>
        <div class="md-search-result" data-md-component="result">
          <div class="md-search-result__meta">
            Type to start searching
          </div>
          <ol class="md-search-result__list"></ol>
        </div>
      </div>
    </div>
  </div>
</div>
            
          
        </div>

         -->
         
         <div class="md-flex__cell md-flex__cell--shrink">
            <div class="md-flex__ellipsis md-header-nav__lang">
                <div>
                    <button onclick="window.location.href = 'https://awssecworkshops.com/';" class="md-lang-dropbtn fa fa-home"></button>
                </div>
            </div>
        </div>
  
        <!-- Repository containing source -->
        
          <div class="md-flex__cell md-flex__cell--shrink">
            <div class="md-header-nav__source">
              


  

<a href="https://github.com/aws-samples/amazon-cognito-identity-management-workshop/" title="Go to repository" class="md-source" data-md-source="github">
  
    <div class="md-source__icon">
      <svg viewBox="0 0 24 24" width="24" height="24">
        <use xlink:href="#__github" width="24" height="24"></use>
      </svg>
    </div>
  
  <div class="md-source__repository">
    aws-samples/amazon-cognito-identity-management-workshop
  </div>
</a>
            </div>
          </div>
        
      </div>
    </nav>
  </header>
    
    <div class="md-container">
      
        
      
      
        

<nav class="md-tabs" data-md-component="tabs">
  <div class="md-tabs__inner md-grid">
    <ul class="md-tabs__list">
      
        
  <li class="md-tabs__item">
    
      <a href=".." title="Overview" class="md-tabs__link md-tabs__link--active">
        Overview
      </a>
    
  </li>

      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
    </ul>
  </div>
</nav>
      
      <main class="md-main">
        <div class="md-main__inner md-grid" data-md-component="container">
          
            
              <div class="md-sidebar md-sidebar--primary" data-md-component="navigation">
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    <!--
  Copyright (c) 2016-2019 Martin Donath <martin.donath@squidfunk.com>
  Permission is hereby granted, free of charge, to any person obtaining a copy
  of this software and associated documentation files (the "Software"), to
  deal in the Software without restriction, including without limitation the
  rights to use, copy, modify, merge, publish, distribute, sublicense, and/or
  sell copies of the Software, and to permit persons to whom the Software is
  furnished to do so, subject to the following conditions:
  The above copyright notice and this permission notice shall be included in
  all copies or substantial portions of the Software.
  THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR
  IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,
  FITNESS FOR A PARTICULAR PURPOSE AND NON-INFRINGEMENT. IN NO EVENT SHALL THE
  AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER
  LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING
  FROM, OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS
  IN THE SOFTWARE.
-->

<!-- Main navigation -->
<nav class="md-nav md-nav--primary" data-md-level="0">

  <!-- Site title -->
  <label class="md-nav__title md-nav__title--site" for="__drawer">
    <a href="https://serverless-idm.awssecworkshops.com/"
        title="AWS Identity: Using Amazon Cognito for serverless consumer apps" class="md-nav__button md-logo">
      
        <img src="../assets/images/aws_smile_logo.png" width="48" height="48" />
      
    </a>
    Using Amazon Cognito for serverless consumer apps
  </label>

  <!-- Repository containing source -->
  
    <div class="md-nav__source">
      


  

<a href="https://github.com/aws-samples/amazon-cognito-identity-management-workshop/" title="Go to repository" class="md-source" data-md-source="github">
  
    <div class="md-source__icon">
      <svg viewBox="0 0 24 24" width="24" height="24">
        <use xlink:href="#__github" width="24" height="24"></use>
      </svg>
    </div>
  
  <div class="md-source__repository">
    aws-samples/amazon-cognito-identity-management-workshop
  </div>
</a>
    </div>
  

  <!-- Render item list -->
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
      


  <li class="md-nav__item">
    <a href=".." title="Overview" class="md-nav__link">
      Overview
    </a>
  </li>

    
      
      
      


  <li class="md-nav__item">
    <a href="../00-env-setup/" title="Module 0: Environment setup" class="md-nav__link">
      Module 0: Environment setup
    </a>
  </li>

    
      
      
      


  <li class="md-nav__item">
    <a href="../01-user-auth/" title="Module 1: User flows" class="md-nav__link">
      Module 1: User flows
    </a>
  </li>

    
      
      
      


  <li class="md-nav__item">
    <a href="../02-backend-auth/" title="Module 2: Backend authorization" class="md-nav__link">
      Module 2: Backend authorization
    </a>
  </li>

    
      
      
      


  <li class="md-nav__item">
    <a href="../03-iam-auth/" title="Module 3: Temporary AWS credentials" class="md-nav__link">
      Module 3: Temporary AWS credentials
    </a>
  </li>

    
      
      
      


  <li class="md-nav__item">
    <a href="../04-clean-up/" title="Module 4: Clean up" class="md-nav__link">
      Module 4: Clean up
    </a>
  </li>

    
      
      
      


  <li class="md-nav__item">
    <a href="../contribute/" title="Contributing" class="md-nav__link">
      Contributing
    </a>
  </li>

    
      
      
      


  <li class="md-nav__item">
    <a href="../license/" title="License" class="md-nav__link">
      License
    </a>
  </li>

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
              <div class="md-sidebar md-sidebar--secondary" data-md-component="toc">
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    
<nav class="md-nav md-nav--secondary">
  
  
    
  
  
    <label class="md-nav__title" for="__toc">Table of contents</label>
    <ul class="md-nav__list" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#pre-sign-up-validation" title="Pre sign-up validation" class="md-nav__link">
    Pre sign-up validation
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#customize-welcome-message" title="Customize welcome message" class="md-nav__link">
    Customize welcome message
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#customize-the-claims-in-the-id-token" title="Customize the claims in the ID Token" class="md-nav__link">
    Customize the claims in the ID Token
  </a>
  
</li>
      
      
      
      
      
    </ul>
  
</nav>
                  </div>
                </div>
              </div>
            
          
          <div class="md-content">
            <article class="md-content__inner md-typeset">
              
                
                  <a href="https://github.com/aws-samples/amazon-cognito-identity-management-workshop/edit/master/docs/01-user-auth-triggers.md" title="Edit this page" class="md-icon md-content__icon">&#xE3C9;</a>
                
                
                <h1 id="module-1-ext-1-lambda-triggers">Module 1 <small> EXT 1 - Lambda Triggers</small></h1>
<p><strong>Time</strong>: 10 minutes</p>
<p>Your current configuration supports a fairly generic user sign-up and sign-in flow.  If you have unique requirments for customized flows, you can leverage the built Lambda triggers.  These will trigger AWS Lambda functions during user pool operation such as user sign-up, confirmation, and sign-in.  You add authentication challenges, migrate users, and customize verification messages.</p>
<h2 id="pre-sign-up-validation">Pre sign-up validation</h2>
<p>Use the Lambda triggers to validate the email domain of the user to ensure it's a user from an approved domain prior to allowing them to sign-up.</p>
<ol>
<li>
<p>Open the <a href="https://console.aws.amazon.com/lambda/home?" target="_blank">AWS Lambda</a> console.</p>
</li>
<li>
<p>Choose the <strong>serverless-idm-wksp-pre-sign-up</strong> function.</p>
<div class="admonition info">
<p class="admonition-title">The function was automatically created as part of the environment configuration CloudFormation template but is missing the application code.</p>
</div>
</li>
<li>
<p>Copy and paste the code below and save your function:</p>
</li>
</ol>
<div class="codehilite"><pre><span></span><span class="kn">from</span> <span class="nn">__future__</span> <span class="kn">import</span> <span class="n">print_function</span>

<span class="k">def</span> <span class="nf">lambda_handler</span><span class="p">(</span><span class="n">event</span><span class="p">,</span> <span class="n">context</span><span class="p">):</span>

    <span class="c1"># Log event</span>
    <span class="k">print</span><span class="p">(</span><span class="n">event</span><span class="p">)</span>

    <span class="c1"># Set the user pool confirmation flags (you can user these to automatically confirm and a user and associated attributes)</span>
    <span class="n">event</span><span class="p">[</span><span class="s1">&#39;response&#39;</span><span class="p">][</span><span class="s1">&#39;autoConfirmUser&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">False</span>
    <span class="n">event</span><span class="p">[</span><span class="s1">&#39;response&#39;</span><span class="p">][</span><span class="s1">&#39;autoVerifyEmail&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">False</span>
    <span class="n">event</span><span class="p">[</span><span class="s1">&#39;response&#39;</span><span class="p">][</span><span class="s1">&#39;autoVerifyPhone&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">False</span>

    <span class="c1"># Set whitelisted domains</span>
    <span class="n">domains</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;example.com&quot;</span><span class="p">]</span>

    <span class="c1"># Split the email address so we can compare domains</span>
    <span class="n">address</span> <span class="o">=</span> <span class="n">event</span><span class="p">[</span><span class="s1">&#39;request&#39;</span><span class="p">][</span><span class="s1">&#39;userAttributes&#39;</span><span class="p">][</span><span class="s1">&#39;email&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;@&#39;</span><span class="p">)</span>

    <span class="c1"># Validate the user is from a whitelisted domain&#39;</span>
    <span class="k">if</span> <span class="n">address</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="ow">in</span> <span class="n">domains</span><span class="p">:</span>
        <span class="k">print</span><span class="p">(</span><span class="s1">&#39;Pre Sign Up validation succeeded for </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">event</span><span class="p">[</span><span class="s1">&#39;userName&#39;</span><span class="p">])</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">print</span><span class="p">(</span><span class="s1">&#39;Pre Sign Up validation failed for </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">event</span><span class="p">[</span><span class="s1">&#39;userName&#39;</span><span class="p">])</span>
        <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s2">&quot;Cannot sign up for the application with that email address.&quot;</span><span class="p">)</span>

    <span class="c1"># Return to Amazon Cognito</span>
    <span class="k">return</span> <span class="n">event</span>
</pre></div>


<div class="admonition info">
<p class="admonition-title">Be sure to replace the <em>example.com</em> domain after you've tested so that your user can pass the pre-signup validation.</p>
</div>
<p>Now that your Lambda function is configured, you can configure the trigger within your Cognito User Pool.</p>
<ol>
<li>
<p>Open the <a href="https://console.aws.amazon.com/cognito/home?" target="_blank">Amazon Cognito</a> console.</p>
</li>
<li>
<p>Choose the <strong>WildRydes</strong> User Pool.</p>
</li>
<li>
<p>Click <strong>Triggers</strong> on the left navigation.</p>
</li>
<li>
<p>Under <strong>Pre sign-up</strong> choose <strong>serverless-idm-wksp-pre-sign-up</strong> and click <strong>Save Changes</strong>.</p>
</li>
</ol>
<p>Now test out your pre validation logic by deleting the existing user in your User Pool (or create a new user) and ensure the function is triggering and properly validating the email address.  Feel free to play around with the logic to test out different validation scenarios. </p>
<h2 id="customize-welcome-message">Customize welcome message</h2>
<p>Now leverage the <strong>Custom Message</strong> trigger to customize the welcome message.</p>
<ol>
<li>
<p>Open the <a href="https://console.aws.amazon.com/lambda/home?" target="_blank">AWS Lambda</a> console.</p>
</li>
<li>
<p>Choose the <strong>serverless-idm-wksp-custom-message</strong> function.</p>
<div class="admonition info">
<p class="admonition-title">The function was automatically created as part of the environment configuration CloudFormation template but is missing the application code.</p>
</div>
</li>
<li>
<p>Copy and paste the code below and save your function:</p>
</li>
</ol>
<div class="codehilite"><pre><span></span><span class="kn">from</span> <span class="nn">__future__</span> <span class="kn">import</span> <span class="n">print_function</span>

<span class="k">def</span> <span class="nf">lambda_handler</span><span class="p">(</span><span class="n">event</span><span class="p">,</span> <span class="n">context</span><span class="p">):</span>

    <span class="c1"># Log event</span>
    <span class="k">print</span><span class="p">(</span><span class="n">event</span><span class="p">)</span>

    <span class="c1"># This example uses a custom attribute &#39;custom:domain&#39;</span>
    <span class="k">if</span> <span class="n">event</span><span class="p">[</span><span class="s1">&#39;triggerSource&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;CustomMessage_SignUp&quot;</span><span class="p">:</span>
        <span class="n">event</span><span class="p">[</span><span class="s1">&#39;response&#39;</span><span class="p">][</span><span class="s1">&#39;smsMessage&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;Bienvenido al servicio WildRydes. Su c贸digo de confirmaci贸n es </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">event</span><span class="p">[</span><span class="s1">&#39;request&#39;</span><span class="p">][</span><span class="s1">&#39;codeParameter&#39;</span><span class="p">]</span>
        <span class="n">event</span><span class="p">[</span><span class="s1">&#39;response&#39;</span><span class="p">][</span><span class="s1">&#39;emailSubject&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;Bienvenido a WildRydes!&#39;</span>
        <span class="n">event</span><span class="p">[</span><span class="s1">&#39;response&#39;</span><span class="p">][</span><span class="s1">&#39;emailMessage&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;Bienvenido al servicio WildRydes. Su c贸digo de confirmaci贸n es </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">event</span><span class="p">[</span><span class="s1">&#39;request&#39;</span><span class="p">][</span><span class="s1">&#39;codeParameter&#39;</span><span class="p">]</span>

    <span class="c1"># Return to Amazon Cognito</span>
    <span class="k">return</span> <span class="n">event</span>
</pre></div>


<div class="admonition question">
<p class="admonition-title">Take note of the event TriggerSource.  When else will this Lambda function get triggered?</p>
</div>
<p>Now that your Lambda function is configured, you can configure the trigger within your Cognito User Pool.</p>
<ol>
<li>
<p>Open the <a href="https://console.aws.amazon.com/cognito/home?" target="_blank">Amazon Cognito</a> console.</p>
</li>
<li>
<p>Choose the <strong>WildRydes</strong> User Pool.</p>
</li>
<li>
<p>Click <strong>Triggers</strong> on the left navigation.</p>
</li>
<li>
<p>Under <strong>Custom Message</strong> choose <strong>serverless-idm-wksp-custom-message</strong> and click <strong>Save Changes</strong>.</p>
</li>
</ol>
<h2 id="customize-the-claims-in-the-id-token">Customize the claims in the ID Token</h2>
<p>Now leverage the <strong>pre token generation</strong> trigger to customize the claims in the ID token before it is issued.</p>
<ol>
<li>
<p>Open the <a href="https://console.aws.amazon.com/lambda/home?" target="_blank">AWS Lambda</a> console.</p>
</li>
<li>
<p>Choose the <strong>serverless-idm-wksp-pre-token-gen</strong> function.</p>
<div class="admonition info">
<p class="admonition-title">The function was automatically created as part of the environment configuration CloudFormation template but is missing the application code.</p>
</div>
</li>
<li>
<p>Copy and paste the code below and save your function:</p>
</li>
</ol>
<div class="codehilite"><pre><span></span><span class="kn">from</span> <span class="nn">__future__</span> <span class="kn">import</span> <span class="n">print_function</span>

<span class="k">def</span> <span class="nf">lambda_handler</span><span class="p">(</span><span class="n">event</span><span class="p">,</span> <span class="n">context</span><span class="p">):</span>

    <span class="c1"># Log event</span>
    <span class="k">print</span><span class="p">(</span><span class="n">event</span><span class="p">)</span>

    <span class="c1"># Customize the token</span>
    <span class="k">if</span> <span class="n">event</span><span class="p">[</span><span class="s1">&#39;triggerSource&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;TokenGeneration_Authentication&#39;</span><span class="p">:</span>
        <span class="n">event</span><span class="p">[</span><span class="s1">&#39;response&#39;</span><span class="p">][</span><span class="s1">&#39;claimsOverrideDetails&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
            <span class="c1"># Suppress the phone number claims</span>
            <span class="s1">&#39;claimsToSuppress&#39;</span><span class="p">:</span> <span class="p">[</span><span class="s1">&#39;phone_number&#39;</span><span class="p">,</span> <span class="s1">&#39;phone_number_verified&#39;</span><span class="p">],</span>
            <span class="c1"># Add a rewards claim</span>
            <span class="s1">&#39;claimsToAddOrOverride&#39;</span><span class="p">:</span> <span class="p">{</span>
                <span class="s2">&quot;rewards&quot;</span><span class="p">:</span> <span class="s2">&quot;platinum&quot;</span>
            <span class="p">},</span>
        <span class="p">}</span>

    <span class="c1"># Return to Amazon Cognito</span>

    <span class="k">return</span> <span class="n">event</span>
</pre></div>


<div class="admonition question">
<p class="admonition-title">Take note of the event TriggerSource.  When else will this Lambda function get triggered?</p>
</div>
<p>Now that your Lambda function is configured, you can configure the trigger within your Cognito User Pool.</p>
<ol>
<li>
<p>Open the <a href="https://console.aws.amazon.com/cognito/home?" target="_blank">Amazon Cognito</a> console.</p>
</li>
<li>
<p>Choose the <strong>WildRydes</strong> User Pool.</p>
</li>
<li>
<p>Click <strong>Triggers</strong> on the left navigation.</p>
</li>
<li>
<p>Under <strong>Pre Token Generation</strong> choose <strong>serverless-idm-wksp-pre-token-gen</strong> and click <strong>Save Changes</strong>.</p>
</li>
</ol>
<p>Now you can authenticate to the application again, copy the ID token, and paste it into <a href="http://jwt.io" target="_blank">JWT.io</a> to verify that the claims have been dynamically updated.</p>
<p><a href="https://serverless-idm.awssecworkshops.com/01-user-auth/#end-of-module-1"><strong>Back to Module 1</strong></a></p>
                
                  
                
              
              
                


              
            </article>
          </div>
        </div>
      </main>
      
        
<footer class="md-footer">
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-footer-copyright">
        
          <div class="md-footer-copyright__highlight">
            &copy; 2019, Amazon Web Services, Inc. or its affiliates. All rights reserved.
          </div>
        
        powered by
        <a href="https://www.mkdocs.org">MkDocs</a>
        and
        <a href="https://squidfunk.github.io/mkdocs-material/">
          Material for MkDocs</a>
      </div>
      
  <div class="md-footer-social">
    <link rel="stylesheet" href="../assets/fonts/font-awesome.css">
    
      <a href="https://awssecworkshops.com" class="md-footer-social__link fa fa-home"></a>
    
      <a href="https://aws.amazon.com/security/" class="md-footer-social__link fa fa-shield"></a>
    
      <a href="https://twitter.com/awssecurityinfo?lang=en" class="md-footer-social__link fa fa-twitter"></a>
    
      <a href="https://aws.amazon.com/blogs/security/" class="md-footer-social__link fa fa-rss"></a>
    
  </div>

    </div>
  </div>
</footer>
      
    </div>
    
      <script src="../assets/javascripts/application.d9aa80ab.js"></script>
      
      <script>app.initialize({version:"1.0.4",url:{base:".."}})</script>
      
    
  </body>
</html>